<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>IOT - Accueil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/global.css" />
  <link rel="stylesheet" href="assets/css/navbar.css" />
  <link rel="stylesheet" href="assets/css/chat.css" />
  <link rel="stylesheet" href="assets/css/auth-visibility.css" />
  <style>
    /* Style pour le bouton de mode en bas Ã  gauche */
    .mode-switch-container {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      display: none; /* CachÃ© par dÃ©faut, affichÃ© seulement si connectÃ© */
    }

    .mode-switch {
      background: rgba(10, 20, 40, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .mode-switch-title {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-bottom: 6px;
    }

    .mode-buttons {
      display: flex;
      gap: 6px;
    }

    .mode-btn {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.05);
      color: #f5f5f5;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.8rem;
    }

    .mode-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: #00e0ff;
    }

    .mode-btn.active {
      background: linear-gradient(90deg, #00e0ff, #7b61ff);
      color: #050816;
      font-weight: 600;
      border: none;
    }

    .mode-btn .icon {
      margin-right: 4px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="logo">IOT</div>
    <nav>
      <a href="index.html">Accueil</a>
      <a href="audio-spectrum.html">Spectre Audio</a>
      <a href="login.html" class="login-btn-header">Connexion</a>
      <a href="register.html" class="login-btn-header">S'inscrire</a>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div class="hero-content">
        <h1>Web IOT</h1>
        <p>Projet de groupe</p>
        <button id="demo-btn" class="submit-btn">Connexion</button>
      </div>
    </section>

    
    <section id="mqtt-chat-section" class="section-chat" style="display: none;">
      <h2>ðŸ’¬ Messagerie IoT</h2>
      <p style="opacity: 0.8; margin-bottom: 16px;">
        Envoyez des messages Ã  vos appareils connectÃ©s et Ã  vos collÃ¨gues
      </p>

      <div id="mqtt-status" style="margin-bottom: 16px; font-size: 0.9rem;">
        <span style="color: #ff7b7b;">âš« DÃ©connectÃ©</span>
      </div>

      <div class="chat-container">
        <div id="chat-messages" class="chat-messages">
          <p style="opacity: 0.6; text-align: center;">Chargement des messages...</p>
        </div>

        <form id="chat-form" class="chat-form">
          <input 
            type="text" 
            id="chat-input" 
            name="message" 
            placeholder="Tapez votre message..."
            maxlength="500"
            required 
          />
          <button type="submit" class="submit-btn">Envoyer</button>
        </form>
      </div>
    </section>

    <!-- Bouton de switch de mode en bas Ã  gauche -->
    <div class="mode-switch-container" id="mode-switch-container">
      <div class="mode-switch">
        <div class="mode-switch-title">Mode ESP32</div>
        <div class="mode-buttons">
          <button class="mode-btn active" id="mode-display" data-mode="display">
            <span class="icon">ðŸ“º</span>
            <span>Affichage</span>
          </button>
          <button class="mode-btn" id="mode-micro" data-mode="micro">
            <span class="icon">ðŸŽ¤</span>
            <span>Micro</span>
          </button>
        </div>
      </div>
    </div>
  </main>

  <script src="assets/main.js"></script>
  <script src="assets/mqtt-chat.js"></script>
  <script>
    // Script pour gÃ©rer le switch de mode
    const modeSwitchContainer = document.getElementById('mode-switch-container');
    const modeDisplayBtn = document.getElementById('mode-display');
    const modeMicroBtn = document.getElementById('mode-micro');
    let currentMode = 'display'; // Mode par dÃ©faut : Affichage

    // Afficher le switch de mode seulement si connectÃ©
    async function checkAuthForModeSwitch() {
      try {
        const res = await fetch('/api/auth/me');
        const json = await res.json();
        
        if (json.user) {
          modeSwitchContainer.style.display = 'block';
        } else {
          modeSwitchContainer.style.display = 'none';
        }
      } catch (e) {
        console.error('Erreur vÃ©rification auth pour mode switch:', e);
      }
    }

    // Changer de mode
    async function switchMode(mode) {
      if (currentMode === mode) return;

      currentMode = mode;

      // Mettre Ã  jour l'UI des boutons
      if (mode === 'display') {
        modeDisplayBtn.classList.add('active');
        modeMicroBtn.classList.remove('active');
      } else {
        modeMicroBtn.classList.add('active');
        modeDisplayBtn.classList.remove('active');
      }

      // Envoyer une commande MQTT pour changer le mode sur l'ESP32
      try {
        const command = mode === 'display' ? 'MODE:DISPLAY' : 'MODE:MICRO';
        
        const res = await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: command })
        });

        if (res.ok) {
          console.log(`Mode changÃ© vers: ${mode}`);
          
          // Afficher une notification visuelle
          showModeNotification(mode);
        } else {
          console.error('Erreur lors du changement de mode');
        }
      } catch (err) {
        console.error('Erreur changement mode:', err);
      }
    }

    // Afficher une notification de changement de mode
    function showModeNotification(mode) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(10, 20, 40, 0.95);
        border: 1px solid #00e0ff;
        border-radius: 8px;
        padding: 12px 20px;
        color: #f5f5f5;
        font-size: 0.9rem;
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
      `;
      
      const modeText = mode === 'display' ? 'ðŸ“º Mode Affichage activÃ©' : 'ðŸŽ¤ Mode Micro activÃ©';
      notification.textContent = modeText;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    // Ajouter les animations CSS
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      
      @keyframes slideOut {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(400px);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(style);

    // Event listeners pour les boutons
    modeDisplayBtn.addEventListener('click', () => switchMode('display'));
    modeMicroBtn.addEventListener('click', () => switchMode('micro'));

    // VÃ©rifier l'auth au chargement
    checkAuthForModeSwitch();
  </script>
</body>
</html>